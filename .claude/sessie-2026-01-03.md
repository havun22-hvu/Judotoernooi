# Sessie 3 Januari 2026

## Wat is er gedaan

### 1. Staging Data Opgeschoond
- Alle oude test toernooien verwijderd via SQL TRUNCATE
- Nieuwe Artisan command gemaakt: `php artisan staging:reset`
- Veiligheidscheck: weigert te draaien op production

### 2. Mollie Betalingen Beslissingen
- **Gekozen:** Mollie Connect (organisatoren koppelen eigen account)
- **Reden:** "Judoleraren en administratie gaat vaak niet samen" - one-click simplicity
- **Geen platform fee:** Hogere lease prijs per toernooi ipv per-judoka fee
- **Kosten:** €0.29 per iDEAL transactie (betaald door organisator, direct afgetrokken)

### 3. Mollie Integratie Gebouwd

**Nieuwe bestanden:**
- `app/Http/Controllers/MollieController.php` - OAuth + webhook + simulatie
- `app/Console/Commands/ResetStaging.php` - Staging reset command
- `resources/views/pages/betaling/simulate.blade.php` - iDEAL simulatie

**Aangepaste bestanden:**
- `app/Http/Controllers/CoachPortalController.php` - MollieService integratie
- `resources/views/pages/toernooi/edit.blade.php` - Mollie Connect UI
- `bootstrap/app.php` - CSRF exclusie voor webhook
- `routes/web.php` - Mollie routes

**Van HavunCore ontvangen:**
- `app/Services/MollieService.php` - Dual mode service
- `database/migrations/2026_01_03_120000_add_mollie_connect_to_toernooien.php`
- `config/services.php` updates

### 4. Deploy naar Staging
- Commit: `f520a9f Add Mollie payment integration with simulation mode`
- Caches gecleard

## Coach Betaal Flow

```
1. Coach logt in → ziet judoka's overzicht
2. Voegt judoka's toe (kunnen incompleet zijn)
3. Klik "Afrekenen" → toont NIEUWE volledige onbetaalde judoka's
4. Prijs = aantal × inschrijfgeld (instelbaar per toernooi)
5. Klik "Betaal met iDEAL" → Mollie/simulatie redirect
6. Na betaling → judoka's krijgen betaald_op timestamp
7. Later meer toevoegen → nieuw afrekenen (alleen nieuwe)
```

## Bank Statement Beschrijving

Format: `{toernooi->naam} - {club->naam} - {count} judoka's`

Voorbeeld: "WestFries Open 2026 - Cees Veen - 5 judoka's"

## Nog te doen

### Woensdag (met Cees)
- [ ] Cees' Mollie test account koppelen via OAuth
- [ ] Echte OAuth flow testen (nu alleen simulatie)
- [ ] Mollie app credentials instellen in .env

### Later
- [ ] Platform fallback mode afmaken (voor org zonder eigen Mollie)
- [ ] Betalingsoverzicht dashboard organisator
- [ ] Email bevestiging na betaling?

## Test Commando's

```bash
# Staging resetten
php artisan staging:reset --force

# Lokaal testen
php artisan serve --port=8001
# Ga naar coach portal, voeg judoka's toe, klik afrekenen
```

## Belangrijke Code Locaties

| Wat | Bestand | Regel |
|-----|---------|-------|
| OAuth start | MollieController.php | authorize() |
| OAuth callback | MollieController.php | callback() |
| Betaling aanmaken | CoachPortalController.php | betalenCode() |
| Simulatie mode check | MollieService.php | isSimulationMode() |
| Webhook handler | MollieController.php | webhook() |
| CSRF exclusie | bootstrap/app.php | regel 17-20 |
